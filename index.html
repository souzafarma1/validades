<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Souza Farma - Controle de Validade (Produ√ß√£o)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .container { max-width: 1200px; margin: auto; padding: 1rem; }
        .message-box { position: fixed; top: 20px; right: 20px; padding: 1rem; border-radius: 0.5rem; z-index: 1000; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); transition: opacity 0.3s ease-in-out; }
        input[type="month"] { -webkit-appearance: none; -moz-appearance: none; appearance: none; }
        #expirationDate, #expiration-filter { padding: 6px; line-height: normal; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 50; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1); max-width: 90%; width: 500px; max-height: 90vh; overflow-y: auto; position: relative; }
        .logo-img { max-width: 100%; height: auto; margin: 0 auto 1.5rem; display: block; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        #scanner-modal .modal-content { max-width: 95%; width: 600px; }
        @media (max-width: 640px) {
            .sm\:table-cell { display: none !important; }
        }
        @media print {
            .no-print { display: none !important; }
            table { width: 100%; border-collapse: collapse; }
            th, td { border: 1px solid #ccc; padding: 8px; text-align: left; font-size: 10pt; color: black !important; }
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">

    <div id="app" class="container">
        <header class="py-6 mb-8 bg-white shadow-md rounded-lg no-print">
            <h1 class="text-3xl font-bold text-center text-red-700">Souza Farma - Controle de Validade (ONLINE)</h1>
            <p class="text-center text-gray-500 mt-2">Pronto para Hospedagem Externa e Acesso M√≥vel.</p>
        </header>

        <div id="message-container" class="fixed top-4 right-4 space-y-2 no-print"></div>

        <div class="lg:flex lg:space-x-8">

            <div class="lg:w-1/4 mb-8 lg:mb-0 no-print">
                <div class="bg-white p-6 rounded-xl shadow-xl border border-gray-200">
                    
                    <img src="https://raw.githubusercontent.com/souzaimportadosslz-bot/controledevalidades/main/souza_farma_logo.png"
                                alt="Logomarca Souza Farma"
                                class="logo-img"
                                onerror="this.onerror=null; this.src='https://placehold.co/600x200/DC3545/FFFFFF?text=SOUZA+FARMA';">
                    
                    <div class="flex flex-col space-y-4 mb-6">
                        <button onclick="openCadastroModal()"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-[1.01]">
                            + Cadastrar Novo Produto
                        </button>
                        <button onclick="openImportModal()"
                            class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-[1.01]">
                            Importar Produtos (Inicial)
                        </button>
                        <button onclick="openImportLotesModal()"
                            class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-[1.01]">
                            Atualizar Lotes c/ Validade (Excel)
                        </button>
                        <button onclick="confirmDeleteAll()"
                            class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-[1.01]">
                            ‚ùå Excluir TODO o Invent√°rio
                        </button>
                        </div>

                    <div class="mb-6 border p-4 rounded-lg bg-blue-50">
                        <h3 class="text-lg font-semibold mb-2 text-blue-700">Busca R√°pida (Scan/Digita√ß√£o) - LOTE</h3>
                        <p class="text-sm text-gray-600 mb-2">Escaneie C√≥d. Barras/Interno para **lan√ßar um novo lote**.</p>
                        <div class="flex space-x-2">
                            <input type="text" id="quick-search-input"
                                class="flex-grow p-2 border border-blue-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                                placeholder="Escaneie C√≥d. Barras ou Interno..." onchange="quickLookup(this.value, 'LOTE')">
                            
                            <button onclick="openScannerModal('LOTE')" 
                                class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-lg transition transform hover:scale-105" 
                                title="Acionar C√¢mera / Scanner">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
                            </button>
                        </div>
                    </div>

                </div>
            </div>

            <div class="lg:w-3/4">
                <div class="bg-white p-4 sm:p-6 rounded-xl shadow-xl border border-gray-200">
                    <h2 class="text-2xl font-semibold mb-4 text-blue-700">Produtos em Estoque</h2>

                    <div class="flex space-x-2 mb-4 no-print">
                        <button onclick="exportToCsv()"
                            class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200 ease-in-out text-sm">
                            Exportar para Excel (CSV)
                        </button>
                        <button onclick="printFilteredList()"
                            class="flex-1 bg-gray-700 hover:bg-gray-800 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200 ease-in-out text-sm">
                            Imprimir/Exportar para PDF
                        </button>
                    </div>

                    <div class="mb-4 no-print">
                        <label for="search-input" class="block text-sm font-medium text-gray-700 mb-1">
                            Filtrar Lista por C√≥d. Barras, Interno ou Descri√ß√£o:
                        </label>
                        <div class="flex space-x-2">
                            <input type="text" id="search-input"
                                class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150"
                                placeholder="Digite o c√≥digo ou nome para filtrar a lista..." onkeyup="applyFilters()">
                                
                            <button onclick="openScannerModal('BUSCA')" 
                                class="bg-green-500 hover:bg-green-600 text-white p-2 rounded-lg transition transform hover:scale-105" 
                                title="Acionar C√¢mera / Scanner para Busca">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-4 no-print">
                        <label for="expiration-filter" class="block text-sm font-medium text-gray-700 mb-1">
                            Filtrar por M√™s de Vencimento (MM/AAAA):
                        </label>
                        <input type="month" id="expiration-filter"
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition duration-150"
                            onchange="applyFilters()">
                    </div>


                    <div class="flex flex-wrap text-xs mb-4 p-2 bg-gray-50 rounded-lg border no-print">
                        <span class="mr-4"><span class="inline-block w-3 h-3 rounded-full bg-red-500 mr-1"></span> Vencido/M√™s Atual (0)</span>
                        <span class="mr-4"><span class="inline-block w-3 h-3 rounded-full bg-yellow-600 mr-1"></span> Vence em 1 M√™s</span>
                        <span class="mr-4"><span class="inline-block w-3 h-3 rounded-full bg-orange-500 mr-1"></span> Vence em 2 Meses</span>
                        <span><span class="inline-block w-3 h-3 rounded-full bg-green-400 mr-1"></span> Vence em 3 Meses</span>
                    </div>

                    <div class="max-h-[600px] overflow-y-auto mt-4 border border-gray-200 rounded-lg p-1">
                        <table class="min-w-full divide-y divide-gray-200 table-auto">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr id="list-header-row">
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">C√≥d. Barras</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">C√≥d. Interno</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descri√ß√£o</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Laborat√≥rio</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Validade</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qtd</th>
                                    <th class="px-2 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider no-print">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="medication-list" class="bg-white divide-y divide-gray-200 text-xs">
                                <tr><td colspan="7" class="p-4 text-center text-gray-500">Carregando invent√°rio...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="medication-modal" class="modal-overlay hidden no-print">
        <div class="modal-content">
            <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl" onclick="closeModal()"> &times; </button>
            <h2 class="text-2xl font-semibold mb-6 text-blue-700" id="form-title"> Cadastrar Novo Produto </h2>
            <form id="medication-form">
                <input type="hidden" id="doc-id">
                <div class="mb-4"><label for="barcode" class="block text-sm font-medium text-gray-700 mb-1">C√≥digo de Barras</label><input type="text" id="barcode" name="barcode" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="Ex: 7891234567890"></div>
                <div class="mb-4"><label for="internalCode" class="block text-sm font-medium text-gray-700 mb-1">C√≥digo Interno</label><input type="text" id="internalCode" name="internalCode" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="Ex: MED001"></div>
                <div class="mb-4"><label for="description" class="block text-sm font-medium text-gray-700 mb-1">Descri√ß√£o (Nome do Medicamento)</label><input type="text" id="description" name="description" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="Ex: Dipirona 500mg Comprimidos"></div>
                <div class="mb-4"><label for="laboratory" class="block text-sm font-medium text-gray-700 mb-1">Laborat√≥rio</label><input type="text" id="laboratory" name="laboratory" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="Ex: Sigma Pharma"></div>
                <div class="flex space-x-4 mb-6">
                    <div class="flex-1"><label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">Quantidade</label><input type="number" id="quantity" name="quantity" required min="0" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="0"></div>
                    <div class="flex-1"><label for="expirationDate" class="block text-sm font-medium text-gray-700 mb-1">Validade (MM/AAAA)</label><input type="month" id="expirationDate" name="expirationDate" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"><p class="text-xs text-gray-500 mt-1">Obrigat√≥rio para atualiza√ß√£o.</p></div>
                </div>
                <button type="submit" id="submit-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-[1.01] focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50"> Cadastrar Medicamento </button>
                <button type="button" id="cancel-edit-button" class="w-full mt-2 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200 ease-in-out" onclick="closeModal(); resetForm();"> Cancelar </button>
            </form>
        </div>
    </div>

    <div id="import-modal" class="modal-overlay hidden no-print">
        <div class="modal-content">
            <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl" onclick="closeImportModal()"> &times; </button>
            <h2 class="text-2xl font-semibold mb-6 text-purple-700">Importa√ß√£o Inicial de Produtos</h2>
            <p class="text-sm text-gray-600 mb-4 p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                **Instru√ß√µes:** Exporte sua planilha do Excel para o formato **CSV (Ponto e V√≠rgula)**. A ordem das colunas PODE SER: **BARRAS, INTERNO, DESCRI√á√ÉO, LABORAT√ìRIO, VALIDADE, QUANTIDADE.**
            </p>
            <div class="mb-4"> <label for="bulk-file-input" class="block text-sm font-medium text-gray-700 mb-1"> Arquivo CSV/TSV: </label> <input type="file" id="bulk-file-input" accept=".csv, .tsv" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition duration-150 bg-white"> </div>
            <div class="mb-6">
                <label for="delimiter-select" class="block text-sm font-medium text-gray-700 mb-1"> Separador (Delimitador): </label>
                <select id="delimiter-select" class="w-full p-2 border border-gray-300 rounded-lg">
                    <option value=";">Ponto e V√≠rgula (;)</option> 
                    <option value=",">V√≠rgula (,)</option>
                    <option value="\t">Tabula√ß√£o (TSV)</option>
                </select>
            </div>
            <button id="import-button" onclick="handleBulkImport()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-[1.01] focus:outline-none focus:ring-4 focus:ring-purple-500 focus:ring-opacity-50"> Importar Produtos </button>
            <button type="button" class="w-full mt-2 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200 ease-in-out" onclick="closeImportModal()"> Cancelar </button>
        </div>
    </div>

    <div id="import-lotes-modal" class="modal-overlay hidden no-print">
        <div class="modal-content">
            <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl" onclick="closeImportLotesModal()"> &times; </button>
            <h2 class="text-2xl font-semibold mb-6 text-orange-700">Atualiza√ß√£o de Lotes em Massa com Validade</h2>
            <p class="text-sm text-gray-600 mb-4 p-3 bg-red-50 rounded-lg border border-red-200">
                **ATEN√á√ÉO:** Esta importa√ß√£o ir√° **ADICIONAR/ATUALIZAR LOTES**. A ordem das colunas DEVE ser: **C√ìDIGO DE BARRAS, C√ìDIGO INTERNO, DESCRI√á√ÉO, LABORAT√ìRIO, VALIDADE, QUANTIDADE.** A Validade ser√° **corrigida automaticamente** (ex: `dez-25` ser√° convertido para `2025-12`).
            </p>
            <div class="mb-4"> <label for="bulk-lotes-file-input" class="block text-sm font-medium text-gray-700 mb-1"> Arquivo CSV/TSV: </label> <input type="file" id="bulk-lotes-file-input" accept=".csv, .tsv" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition duration-150 bg-white"> </div>
            <div class="mb-6">
                <label for="delimiter-lotes-select" class="block text-sm font-medium text-gray-700 mb-1"> Separador (Delimitador): </label>
                <select id="delimiter-lotes-select" class="w-full p-2 border border-gray-300 rounded-lg">
                    <option value=";">Ponto e V√≠rgula (;)</option> 
                    <option value=",">V√≠rgula (,)</option>
                    <option value="\t">Tabula√ß√£o (TSV)</option>
                </select>
            </div>
            <button id="import-lotes-button" onclick="handleBulkLotesImport()" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-[1.01] focus:outline-none focus:ring-4 focus:ring-orange-500 focus:ring-opacity-50"> Importar/Atualizar Lotes </button>
            <button type="button" class="w-full mt-2 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200 ease-in-out" onclick="closeImportLotesModal()"> Cancelar </button>
        </div>
    </div>

    <div id="scanner-modal" class="modal-overlay hidden no-print">
        <div class="modal-content" style="max-width: 600px; width: 600px;">
            <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl" onclick="closeScannerModal()"> &times; </button>
            <h2 class="text-xl font-semibold mb-4 text-blue-700">Scanner de C√≥digo de Barras</h2>
            
            <div id="reader">
                </div>
            <p class="mt-4 text-center text-gray-600">Posicione o c√≥digo de barras dentro da √°rea de leitura.</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, onSnapshot, collection, query, where, deleteDoc, getDoc, updateDoc, Timestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 

        const APP_CONFIG = {
            apiKey: "AIzaSyDc9-jix-tXCV8JHzivDR8pY1iCNNJeDPg",
            authDomain: "controle-de-validade-e708a.firebaseapp.com",
            projectId: "controle-de-validade-e708a",
            storageBucket: "controle-de-validade-e708a.firebasestorage.app",
            messagingSenderId: "300173058270",
            appId: "1:300173058270:web:970549624a4c46af3d624f"
        };
        const EXTERNAL_APP_ID = "controle-de-validade-e708a";
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : EXTERNAL_APP_ID;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let firebaseConfig = APP_CONFIG;
        let app, db, auth, userId = null;
        let allMedications = []; 
        let currentFilteredList = []; 
        const COLLECTION_NAME = 'medicamentos';
        let html5QrCode = null;
        let isFirebaseReady = false;

        const MONTH_MAP = { jan: '01', fev: '02', mar: '03', abr: '04', mai: '05', jun: '06', jul: '07', ago: '08', set: '09', out: '10', nov: '11', dez: '12' };

        // --- FUN√á√ïES DE UTILIDADE ---

        // AJUSTADO: Fun√ß√£o ultra-robusta para converter nota√ß√£o cient√≠fica do Excel em n√∫mero completo
        function cleanBarcode(raw) {
            if (!raw) return "";
            let str = raw.toString().trim();
            
            // Corrige locale do Excel (v√≠rgula decimal)
            str = str.replace(',', '.');

            // Se o texto contiver nota√ß√£o cient√≠fica (E+)
            if (str.toUpperCase().includes('E+')) {
                try {
                    // Tenta converter usando formata√ß√£o de precis√£o total
                    // Ex: "7,89857E+12" -> 7898570000000 (ou o valor exato se houver precis√£o no Number)
                    let num = parseFloat(str);
                    if (!isNaN(num)) {
                        // toFixed(0) garante que n√£o tenha decimais e nem nota√ß√£o cient√≠fica no retorno
                        return num.toFixed(0);
                    }
                } catch(e) {
                    console.error("Erro na convers√£o cient√≠fica:", e);
                }
            }
            
            // Fallback: Remove tudo o que n√£o √© d√≠gito
            return str.replace(/[^0-9]/g, '');
        }

        function getStandardExpirationDate(dateStr) {
            if (!dateStr) return null;
            const normalized = dateStr.toLowerCase().trim();
            if (/^\d{4}-\d{2}$/.test(normalized)) return normalized;
            
            const partsMonthYear = normalized.match(/([a-z]+)[-\s/]?(\d{2,4})/); 
            if (partsMonthYear) {
                const month = partsMonthYear[1];
                let year = partsMonthYear[2];
                let monthNumber = MONTH_MAP[month] || month;
                if (year.length === 2) year = (parseInt(year) < 70 ? '20' : '19') + year;
                if (monthNumber.length === 1) monthNumber = '0' + monthNumber;
                return `${year}-${monthNumber}`;
            }
            
            const partsNum = normalized.match(/(\d{1,2})[/\s]?(\d{2,4})/);
            if (partsNum) {
                let monthNumber = partsNum[1].padStart(2, '0');
                let year = partsNum[2];
                if (year.length === 2) year = (parseInt(year) < 70 ? '20' : '19') + year;
                return `${year}-${monthNumber}`;
            }
            return null;
        }

        function getCollectionRef() {
            if (!db || !userId) throw new Error("Firebase n√£o inicializado.");
            return collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME); 
        }
        
        function sortAndRender() {
            allMedications.sort((a, b) => {
                // 1. Tratamento para itens sem validade (v√£o para o final)
                if (!a.expirationDate && b.expirationDate) return 1;
                if (a.expirationDate && !b.expirationDate) return -1;
                if (!a.expirationDate && !b.expirationDate) {
                    return (b.launchedAt || 0) - (a.launchedAt || 0); 
                }
                const dateCompare = a.expirationDate.localeCompare(b.expirationDate);
                if (dateCompare === 0) {
                    return (b.launchedAt || 0) - (a.launchedAt || 0);
                }
                return dateCompare;
            });
            applyFilters();
        }

        function monthDiff(date1Str, date2Str) {
            const parts1 = date1Str.split('-').map(Number);
            const parts2 = date2Str.split('-').map(Number);
            return (parts1[0] - parts2[0]) * 12 + (parts1[1] - parts2[1]);
        }

        function showMessage(text, type = 'success') {
            const container = document.getElementById('message-container');
            const element = document.createElement('div');
            let bgColor, icon;
            if (type === 'success') { bgColor = 'bg-green-100 border-green-400 text-green-700'; icon = '‚úÖ'; } 
            else if (type === 'error') { bgColor = 'bg-red-100 border-red-400 text-red-700'; icon = '‚ùå'; } 
            else { bgColor = 'bg-blue-100 border-blue-400 text-blue-700'; icon = '‚ÑπÔ∏è'; }
            element.className = `message-box ${bgColor} border-l-4`;
            element.innerHTML = `<div class="flex items-center"><span class="mr-2">${icon}</span><span>${text}</span><button class="ml-4 text-gray-500 hover:text-gray-700" onclick="this.parentNode.parentNode.remove()">&times;</button></div>`;
            container.appendChild(element);
            setTimeout(() => { element.style.opacity = '0'; setTimeout(() => element.remove(), 300); }, 5000);
        }

        // Elementos do DOM
        const form = document.getElementById('medication-form');
        const listContainer = document.getElementById('medication-list');
        const searchInput = document.getElementById('search-input');
        const expirationFilterInput = document.getElementById('expiration-filter');
        const quickSearchInput = document.getElementById('quick-search-input');
        const formTitle = document.getElementById('form-title');
        const submitButton = document.getElementById('submit-button');
        const cancelButton = document.getElementById('cancel-edit-button');

        window.openCadastroModal = function() { document.getElementById('medication-modal').classList.remove('hidden'); resetForm(); }
        window.closeModal = function() { document.getElementById('medication-modal').classList.add('hidden'); resetForm(); }
        window.openImportModal = function() { document.getElementById('import-modal').classList.remove('hidden'); }
        window.closeImportModal = function() { document.getElementById('import-modal').classList.add('hidden'); }
        window.openImportLotesModal = function() { document.getElementById('import-lotes-modal').classList.remove('hidden'); }
        window.closeImportLotesModal = function() { document.getElementById('import-lotes-modal').classList.add('hidden'); }
        window.resetForm = function() {
            form.reset();
            document.getElementById('doc-id').value = '';
            formTitle.textContent = 'Cadastrar Novo Produto';
            submitButton.textContent = 'Cadastrar Medicamento';
            cancelButton.classList.add('hidden');
            document.getElementById('barcode').disabled = false;
            document.getElementById('internalCode').disabled = false;
            document.getElementById('description').disabled = false;
            document.getElementById('laboratory').disabled = false;
        }

        async function bootstrap() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                else await signInAnonymously(auth);
                isFirebaseReady = true;
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        onSnapshot(getCollectionRef(), (snapshot) => {
                            allMedications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            sortAndRender();
                        });
                    }
                });
            } catch (e) { showMessage("Erro ao conectar.", "error"); }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isFirebaseReady) return;
            const docId = document.getElementById('doc-id').value;
            const barcode = document.getElementById('barcode').value.trim();
            const internalCode = document.getElementById('internalCode').value.trim();
            const description = document.getElementById('description').value.trim();
            const laboratory = document.getElementById('laboratory').value.trim();
            const quantity = parseInt(document.getElementById('quantity').value, 10);
            const expirationDate = document.getElementById('expirationDate').value;
            
            const data = { 
                barcode, 
                internalCode, 
                description, 
                laboratory, 
                quantity, 
                expirationDate: expirationDate || null, 
                searchTerms: `${barcode} ${internalCode} ${description} ${laboratory}`.toLowerCase(),
                launchedAt: Date.now() 
            };

            try {
                if (docId) await updateDoc(doc(getCollectionRef(), docId), data);
                else await addDoc(getCollectionRef(), data);
                closeModal();
                showMessage("Salvo com sucesso!");
            } catch (e) { showMessage("Erro ao salvar.", "error"); }
        });

        window.deleteMedication = async function(id) {
            if (confirm("Deletar este lote?")) {
                try { await deleteDoc(doc(getCollectionRef(), id)); showMessage("Exclu√≠do!"); } catch (e) { showMessage("Erro.", "error"); }
            }
        }

        window.confirmDeleteAll = async function() {
            if (confirm("‚ö†Ô∏è APAGAR TUDO?")) {
                if (confirm("üõë √öLTIMA CHANCE! CONFIRMAR?")) {
                    const snap = await getDocs(getCollectionRef());
                    const promises = snap.docs.map(d => deleteDoc(doc(getCollectionRef(), d.id)));
                    await Promise.all(promises);
                    showMessage("Invent√°rio zerado.");
                }
            }
        }

        window.handleBulkImport = async function() {
            if (!isFirebaseReady) return;
            const file = document.getElementById('bulk-file-input').files[0];
            if (!file) return;
            const delimiter = document.getElementById('delimiter-select').value;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const lines = e.target.result.split('\n').filter(l => l.trim() !== '');
                const promises = lines.map(line => {
                    const v = line.replace(/\r/g, '').split(delimiter).map(x => x.trim());
                    if (v.length >= 5) {
                        let rawBarcode = v[0], internalCode = v[1], description = v[2], laboratory = v[3];
                        let barcode = cleanBarcode(rawBarcode); 
                        let expirationDate = null, quantity = 0;
                        if (v.length >= 6) {
                            expirationDate = getStandardExpirationDate(v[4]);
                            quantity = parseInt(v[5], 10) || 0;
                        } else {
                            quantity = parseInt(v[4], 10) || 0;
                        }
                        const data = { 
                            barcode, 
                            internalCode, 
                            description, 
                            laboratory, 
                            quantity, 
                            expirationDate, 
                            searchTerms: `${barcode} ${internalCode} ${description} ${laboratory}`.toLowerCase(),
                            launchedAt: Date.now() 
                        };
                        return addDoc(getCollectionRef(), data);
                    }
                });
                await Promise.all(promises);
                showMessage("Importa√ß√£o conclu√≠da.");
                closeImportModal();
            };
            reader.readAsText(file);
        }

        window.handleBulkLotesImport = async function() {
            if (!isFirebaseReady) return;
            const file = document.getElementById('bulk-lotes-file-input').files[0];
            if (!file) return;
            const delimiter = document.getElementById('delimiter-lotes-select').value;
            const reader = new FileReader();
            reader.onload = async (event) => {
                const rawData = event.target.result;
                const lines = rawData.split('\n').filter(line => line.trim() !== '');
                const snap = await getDocs(getCollectionRef());
                const existing = {};
                snap.forEach(d => { const data = d.data(); if(data.internalCode && data.expirationDate) existing[`${data.internalCode}_${data.expirationDate}`] = d.id; });
                
                const promises = lines.map(line => {
                    const v = line.replace(/\r/g, '').split(delimiter).map(x => x.trim());
                    if (v.length >= 6) {
                        const rawBarcode = v[0], internalCode = v[1], description = v[2], laboratory = v[3];
                        const barcode = cleanBarcode(rawBarcode); 
                        const exp = getStandardExpirationDate(v[4]), quantity = parseInt(v[5], 10) || 0;
                        if (exp) {
                            const data = { 
                                barcode, 
                                internalCode, 
                                description, 
                                laboratory, 
                                quantity, 
                                expirationDate: exp, 
                                searchTerms: `${barcode} ${internalCode} ${description} ${laboratory}`.toLowerCase(),
                                launchedAt: Date.now() 
                            };
                            const key = `${internalCode}_${exp}`;
                            return existing[key] ? updateDoc(doc(getCollectionRef(), existing[key]), data) : addDoc(getCollectionRef(), data);
                        }
                    }
                });
                await Promise.all(promises);
                showMessage("Lotes atualizados.");
                closeImportLotesModal();
            };
            reader.readAsText(file);
        }

        function renderMedications(meds) {
            listContainer.innerHTML = ''; 
            currentFilteredList = meds;
            const now = new Date().toISOString().slice(0, 7);
            meds.forEach(med => {
                const displayDate = med.expirationDate ? `${med.expirationDate.split('-')[1]}/${med.expirationDate.split('-')[0]}` : 'PENDENTE';
                let expClass = 'bg-white', textCol = 'text-black font-bold';
                
                if (med.expirationDate) {
                    const diff = monthDiff(med.expirationDate, now);
                    if (diff <= 0) { expClass = 'bg-red-100'; }
                    else if (diff === 1) { expClass = 'bg-yellow-200'; }
                    else if (diff === 2) { expClass = 'bg-amber-200'; }
                    else if (diff === 3) { expClass = 'bg-green-100'; }
                }
                
                const row = document.createElement('tr');
                row.className = `hover:bg-gray-50 ${expClass} border-l-4 border-r-4`;
                row.innerHTML = `
                    <td class="px-2 py-2 text-xs ${textCol} hidden sm:table-cell">${med.barcode}</td>
                    <td class="px-2 py-2 text-xs ${textCol}">${med.internalCode}</td>
                    <td class="px-2 py-2 text-xs ${textCol}">${med.description}</td>
                    <td class="px-2 py-2 text-xs ${textCol} hidden sm:table-cell">${med.laboratory}</td>
                    <td class="px-2 py-2 text-xs ${textCol}">${displayDate}</td>
                    <td class="px-2 py-2 text-xs ${textCol}">${med.quantity}</td>
                    <td class="px-2 py-2 text-right text-xs no-print">
                        <button onclick="loadForEdit('${med.id}')" class="text-blue-600 mr-2 font-bold">Edit</button>
                        <button onclick="deleteMedication('${med.id}')" class="text-red-600 font-bold">Exc</button>
                    </td>`;
                listContainer.appendChild(row);
            });
        }

        window.applyFilters = () => {
            const search = searchInput.value.toLowerCase().trim();
            const exp = expirationFilterInput.value;
            let filtered = allMedications;
            if (search) filtered = filtered.filter(m => m.searchTerms.includes(search));
            if (exp) filtered = filtered.filter(m => m.expirationDate === exp);
            renderMedications(filtered);
        }

        window.loadForEdit = (id) => {
            const item = allMedications.find(m => m.id === id);
            if (item) {
                document.getElementById('medication-modal').classList.remove('hidden');
                document.getElementById('doc-id').value = item.id;
                document.getElementById('barcode').value = item.barcode;
                document.getElementById('internalCode').value = item.internalCode;
                document.getElementById('description').value = item.description;
                document.getElementById('laboratory').value = item.laboratory;
                document.getElementById('quantity').value = item.quantity;
                document.getElementById('expirationDate').value = item.expirationDate || '';
                formTitle.textContent = `Editar Lote: ${item.description}`;
                submitButton.textContent = 'Salvar Altera√ß√µes';
                cancelButton.classList.remove('hidden');
                ['barcode','internalCode','description','laboratory'].forEach(id => document.getElementById(id).disabled = true);
            }
        }

        window.quickLookup = (query) => {
            const q = query.toLowerCase().trim();
            const item = allMedications.find(m => m.barcode.toLowerCase() === q || m.internalCode.toLowerCase() === q);
            if (item) {
                document.getElementById('medication-modal').classList.remove('hidden');
                ['barcode','internalCode','description','laboratory'].forEach(id => { document.getElementById(id).value = item[id]; document.getElementById(id).disabled = true; });
                document.getElementById('quantity').value = '';
                document.getElementById('expirationDate').value = '';
                formTitle.textContent = `Novo Lote: ${item.description}`;
                submitButton.textContent = 'Adicionar Lote';
            }
        }

        window.openScannerModal = (mode) => {
            document.getElementById('scanner-modal').classList.remove('hidden');
            window.scannerMode = mode;
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 30, qrbox: { width: 150, height: 80 } }, (text) => {
                window.closeScannerModal();
                if (mode === 'BUSCA') { searchInput.value = text; applyFilters(); }
                else { quickSearchInput.value = text; quickLookup(text); }
            });
        }

        window.closeScannerModal = () => {
            document.getElementById('scanner-modal').classList.add('hidden');
            if (html5QrCode) html5QrCode.stop();
        }

        bootstrap();
    </script>
</body>
</html>
